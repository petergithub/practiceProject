<?xml version="1.0" encoding="ISO-8859-1"?>

<project name="dot-Hibernate-Mapping-Generation" default="hibernate" basedir="../">
    <property file="config/marshcm.properties" />

    <property name="hibernate.config.dir" value="${config.dir}" />
    <property name="spring.config.dir" value="${config.dir}" />
	<property name="log4j.config.dir" value="${config.dir}" />
    <property name="model.src.dir"   value="${src.dir}/model" />
    <property name="model.build.dir" value="${build.dir}" />
	<property name="webinf.dir" value="${webinf.dir}" />
    <property name="hibernate-mapping.gen.dir" value="${build.dir}" />

    <!-- =================================================================== -->
    <!-- Define the class path                                               -->
    <!-- =================================================================== -->
    <path id="xdoclet.class.path">
        <fileset dir="${xdoclet.lib.dir}">
            <include name="*.jar"/>
        </fileset>
    </path>

    <!-- =================================================================== -->
    <!-- Initialise                                                          -->
    <!-- =================================================================== -->
    <target name="init" depends = "clean">
        <tstamp>
            <format property="TODAY" pattern="d-MM-yy"/>
        </tstamp>
        <taskdef
            name="hibernatedoclet"
            classname="xdoclet.modules.hibernate.HibernateDocletTask"
            classpathref="xdoclet.class.path"
        />
    </target>

	
    <!-- =================================================================== -->
    <!-- Prepares the directory structure                                    -->
    <!-- =================================================================== -->
    <target name="prepare" depends="init">
        <mkdir dir="${hibernate-mapping.gen.dir}"/>
    </target>

	<target name="copyLib" depends="prepare" description="copy libs to WEB-INF/lib">

	<copy todir="${webinf.lib.dir}" preservelastmodified="true">
			<fileset dir="${lib.root.dir}">
				<include name="*.jar"/>
			</fileset>
			<fileset dir="${lib.root.dir}/hibernate">
				<include name="*.jar"/>
			</fileset>
			<fileset dir="${lib.root.dir}/spring">
				<include name="*.jar"/>
			</fileset>
			<fileset dir="${lib.root.dir}/struts">
				<include name="*.jar"/>
			</fileset>
		    <fileset dir="${lib.root.dir}/pilibs">
						<include name="*.jar"/>
			</fileset>
		</copy>
	</target>


    <!-- =================================================================== -->
    <!-- Invoke XDoclet's hibernate                                          -->
    <!-- =================================================================== -->
    <target name="hibernate" depends="prepare, copyLib" description="Generate mapping documents (run jar first)">

        <echo>+---------------------------------------------------+</echo>
        <echo>|                                                   |</echo>
        <echo>| R U N N I N G   H I B E R N A T E D O C L E T     |</echo>
        <echo>|                                                   |</echo>
        <echo>+---------------------------------------------------+</echo>

        <hibernatedoclet
            destdir="${hibernate-mapping.gen.dir}"
            mergedir="${model.src.dir}"
            excludedtags="@version,@author,@todo,@see"
            addedtags="@xdoclet-generated at ${TODAY},@copyright DoubleBridge Technologies,@author Ken He"
            force="true"
            verbose="false">

            <fileset dir="${model.src.dir}">
            </fileset>

            <hibernate version="2.0"/>
        </hibernatedoclet>

        <!--<copy file="${hibernate.config.dir}/hibernate.cfg.xml" todir="${model.build.dir}" />
        <copy file="${spring.config.dir}/application.context.xml" todir="${model.build.dir}" />
        <copy file="${log4j.config.dir}/log4j.properties" todir="${model.build.dir}" />
    	<copy file="${config.dir}/dets.properties" todir="${model.build.dir}" />-->
    	<copydir dest="${model.build.dir}" src="${config.dir}"></copydir>
    	

    </target>

    <!-- =================================================================== -->
    <!-- Clean                                                               -->
    <!-- =================================================================== -->
    <target name="clean">
    	<delete>
    		<fileset dir="${hibernate-mapping.gen.dir}" includes="**/*.xml"/>
        </delete>
        
       	<mkdir dir="${webinf.lib.dir}"></mkdir>
        <delete>
        	<fileset dir="${webinf.lib.dir}"></fileset>
        </delete>
    </target>

	<path id="schemaexport.class.path">
		<fileset dir="${hibernate.lib.dir}">
			<include name="**/*.jar"/>
			<include name="**/*.zip"/>
		</fileset>
		<pathelement path="${model.build.dir}" />
	</path>

	<target name="schemaexport">
    	<taskdef name="schemaexport"
        	classname="net.sf.hibernate.tool.hbm2ddl.SchemaExportTask"
        	classpathref="schemaexport.class.path"
        />

	    <schemaexport
	    	properties="config/hibernate.properties"
	        quiet="no"
	        text="yes"
	        drop="no"
	        delimiter=";"
	        output="${marshcm.home.dir}/schema-export.sql"
	    >

	        <fileset dir="${hibernate-mapping.gen.dir}">
	            <include name="**/*.hbm.xml"/>
	        </fileset>
	    </schemaexport>
	</target>
</project>
